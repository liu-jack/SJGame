S.SSCL.Games=Backbone.Collection.extend({model:S.SSMO.Game,initialize:function(){_.bindAll(this,"parse")},parse:function(e){return e.data}});S.SSCT.Game=Backbone.Controller.extend({initialize:function(){_.bindAll(this)},validate:function(e,s){this.validModel=S.SSCT.GetHandler("Model","ValidCode"),this.validModel.on("error",_.bind(function(e,a){s.error(a.msg||a),this.validModel.off("error")},this));var a=this.validModel.set({alphaCode:e});a&&this.validModel.validCode({alphaCode:e},{success:s.success,error:function(e,a){console.log("resp",a),s.error(a.msg)}})},getGameInfo:function(e){if(null==this.gameId){var s=S.sdkBase.request(S.sdkBase.servType.COMMON,S.sdkBase.actions.GET_GAME_INFO);s&&s.success?(this.gameId=s.data.gameId,this.gameInfo=s.data,e&&e.success&&e.success.apply(this,[s.data])):e&&e.error&&e.error.apply(this,[s])}else _.isUndefined(e)||_.isUndefined(e.success)||!_.isFunction(e.success)||e.success.apply(this,[this.gameInfo])},getOptnTestGameInfo:function(e){S.SSCT.GetHandler("Model","Game").getOptnTestGameInfo({success:function(s,a){e.success(a.data)},error:function(s,a){e.error(a.data)},quiet:!0})}});S.SSMO.Game=Backbone.Model.extend({initialize:function(){_.bindAll(this)},getOptnTestGameInfo:function(e){this.url=S.sdkBase.servType.SDKSERVER+"/"+S.sdkBase.actions.CALL_SDK_SERVER+"/"+rConfig.apis.GET_OPENTEST_GAME_INFO,this.fetch(e)},parse:function(e){return e.data}});S.SSMO.ValidCode=Backbone.Model.extend({initialize:function(){_.bindAll(this),this.url=S.sdkBase.servType.SDKSERVER+"/"+S.sdkBase.actions.CALL_SDK_SERVER+"/"+rConfig.apis.VALID_CODE},validate:function(e){if(!this.isRequest){if(_.isUndefined(e.alphaCode)&&_.isEmpty(e.alphaCode))return"激活码不能为空";if(6!=e.alphaCode.length||e.alphaCode.match(/[^a-z0-9A-Z]+/))return"请输入正确的激活码"}this.isRequest=!1},validCode:function(e,i){this.save(e,i)},parse:function(e){return this.isRequest=!0,e.data}});S.SSVW.Game=Backbone.View.extend({el:"#gameContainer",events:{"onclick #bbsLink":"linkToBBS","onclick #gameCenterLink":"linkToGameCenter","onclick #confirmValidCode":"doConfirm","onclick #exitValidCode":"doExit","onclick #clearCode":"flushInpt","onclick #clearValidCode":"clearValidCode","onclick #validCode":"_inputFocuse","focusout #validCode":"hideClrPass","onclick #toUserCenterLink":"gotoUserCenter","onclick #gotoValidCodeCenter":"gotoValidCodeCenter"},config:{VALID_CODE_ROUTE:"#!game/testWidthCode/[code]"},isRandom:null,initialize:function(){_.bindAll(this),this.gameController=S.SSCT.GetHandler("Controller","Game")},notOpen:function(){S.SCEV.Proxy.trigger(S.SCEV.EventType.PRE_ROUTE,{enterPage:sdk.Log.businesses.PAGE_GAME,enterBusiness:["notOpen"]});var e=this.$el.find("#gameNotOpenMsg"),o="openTestGameMsg",i="";this.gameController.getOptnTestGameInfo(this.gameController.callBackMix(function(n){"B"!=n.status||_.isUndefined(n.message)||_.isEmpty(n.message)?i=ucf.Cache.get(o,!0):(i=n.message,ucf.Cache.set(o,i,3600,!0)),_.isEmpty(i)||e.html(i),e.show()},function(){i=ucf.Cache.get(o,!0),_.isEmpty(i)||e.html(i),e.show()}))},validCode:function(e){S.SCEV.Proxy.trigger(S.SCEV.EventType.PRE_ROUTE,{enterPage:sdk.Log.businesses.PAGE_GAME,enterBusiness:["validateCode"]}),this.isRandom=_.isUndefined(e)||_.isEmpty(e)?"false":e,this.changeClrPass(),this.initLogoutBtn()},testWidthCode:function(e){_.isEmpty(e)||"[code]"===e||$("#validCode").val(e),this.validCode.call(this)},doConfirm:function(){var e=this,o=this.$el.find("#validCode").val(),i=S.SSCT.GetHandler("Controller","User");this.$el.find("#confirmValidCode").attr("disabled","disabled"),this.$el.find("#confirmValidCode").attr("data-disabled","true").addClass("ui-disabled"),this.gameController.validate(o,this.gameController.callBackMix(function(e,o){i.notifyCp({code:o.code,msg:o.msg},i.callBackMix(i.sdkExit))},function(o){e._showErrorMsg(o,"#validCodeNoticeBox"),e.$el.find("#confirmValidCode").removeAttr("disabled"),e.$el.find("#confirmValidCode").attr("data-disabled","").removeClass("ui-disabled")}))},doExit:function(){S.Log.pageClose(),S.SSCT.GetHandler("Controller","User").sdkExit()},flushInpt:function(){_.isUndefined(this.noticeBar)||_.isEmpty(this.noticeBar)||sdk.common.ui.NoticeBox.hide(this.noticeBar,null,"slide"),this.$el.find("#validCode").val("")},clearValidCode:function(){this.$el.find("#validCode").val(""),this.changeClrPass()},changeClrPass:function(){_.isEmpty($("#validCode").val())?$("#clearValidCode").hide():$("#clearValidCode").show()},hideClrPass:function(){$("#clearValidCode").hide()},initLogoutBtn:function(){S.SCEV.Proxy.trigger(S.SCEV.EventType.SDK_REMOVE_WIN_EVENT,{eventName:"bridgeTopBtnClicked"}),S.SCEV.Proxy.trigger(S.SCEV.EventType.SDK_WINDOW_EVENT,{eventName:"bridgeTopBtnClicked",handler:function(e){"logout"==e.action&&(S.sdkBase.request(S.sdkBase.servType.LOGIN,S.sdkBase.actions.LOGOUT),S.SSCT.GetHandler("Controller","User").sdkExit())}})},linkToBBS:function(){sdk.Log.pageEnter(sdk.Log.businesses.PAGE_GAME,["bbsClick"]),sdk.Log.pageClose(sdk.Log.businesses.PAGE_GAME,["bbsClick"]),sdk.PageCache.set("sdk_redirect_out",1),S.Url.redirect("../bbs/bbs.html")},linkToGameCenter:function(){sdk.Log.pageClose(sdk.Log.businesses.PAGE_GAME,["notOpen"]),sdk.Log.pageEnter(sdk.Log.businesses.PAGE_GAME,["gameCenter"]),S.Url.redirect(eConfig.gameCenter)},_inputFocuse:function(){this.changeClrPass()},_showErrorMsg:function(e,o,i){S.SSCT.GetHandler("Controller","General").sendClientMsg(e),i&&i.apply()},gotoUserCenter:function(){sdk.Log.click(sdk.Log.businesses.PAGE_USER,["h5_ValidCode_to_UserCenter_l"]),S.Url.redirect("../user/user.html#!user")},gotoValidCodeCenter:function(){function e(e,o,i,s,d,l){var r=[];r.push("from="+e),r.push("caller="+o),r.push("version="+i),r.push("gameId="+s),r.push("sid="+d),"Test"===n&&r.push("callback="+encodeURIComponent(window.location.href.replace(window.location.hash,"")+t.config.VALID_CODE_ROUTE)),S.Url.redirect(eConfig.validCodeCenterUrl+"?"+r.join("&")+l)}function o(e){S.SSCT.GetHandler("Controller","User").getCurUserInfo({success:e,error:i})}function i(e){e&&t._showErrorMsg(e.msg||e)}var n=$("#gotoValidCodeCenter").data("source"),s=$("#gotoValidCodeCenter").data("from");sdk.Log.click(sdk.Log.businesses.PAGE_USER,["h5_Code_p",n]);var t=this;this.gameController.getGameInfo({success:function(i){var t=i.gameId;o(function(o){var i=S.global.version;e(s,"sdk",i,t,o.sid,"#!codeCenter/"+n)})},error:function(e){t._showErrorMsg(e.msg)}})}});